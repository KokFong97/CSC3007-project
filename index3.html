<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        .row {
            margin-bottom: 0px;
        }

        .col {
            height: 100%;
        }

        #firstRow {
            height: 7vh;
        }

        #secondRow {
            height: 93vh;
        }

        i {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="row" id="firstRow" style="border-style:dotted">
        <!-- Top Nav bar (Play, Search, Timestamp) -->
        <div class="col s1 offset-s1" style="border-style:dotted">
            <i class="medium material-icons">play_arrow</i>
        </div>
        <div class="col s6 offset-s1" style="border-style:dotted">
            <p>Search</p>
        </div>
        <div class="col s1 offset-s1" style="border-style:dotted">
            <p>1/1/2020</p>
        </div>
    </div>
    <div class="row" id="secondRow">
        <div class="col s9" id="mapDiv" style="border-style:dotted">
            <!-- Map here -->
        </div>
        <div class="col s3" id="chartDiv" style="border-style:dotted">
            <!-- Bar/line chart here -->
            <svg id="chart" style="border-style:dotted"></svg>
        </div>
    </div>

</body>

<script>

    Promise.all([d3.json("covid_data_2.json")]).then(data => {

        $("#mapDiv").click(function () {
            $("#mapDiv").removeClass("s9").addClass("s6");
            $("#chartDiv").removeClass("s3").addClass("s6");
            var dimensions = resizeSVG();
            plotLine(data[0], "2020-05-25", "China", dimensions);
        });

        $("#chartDiv").click(function () {
            $("#mapDiv").removeClass("s6").addClass("s9");
            $("#chartDiv").removeClass("s6").addClass("s3");
            resizeSVG();
            plotBar();
        });
    });

    function initSVG(data) {
        plotMap();
        plotBar();
        return resizeSVG();
    }

    function resizeSVG() {
        var element = document.getElementById('chartDiv');
        var positionInfo = element.getBoundingClientRect();
        var height = positionInfo.height;
        var width = positionInfo.width;

        let margin = { top: 100, right: 100, bottom: 100, left: 100 };
        width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom;

        d3.select("#chart")
            .style("height", height)
            .style("width", width)

        return { margin: margin, height: height, width: width }
    }

    function plotMap() {

    }

    function plotBar() {
        d3.selectAll("#chart > *").remove();
    }

    function plotLine(data, date, country, dimensions) {

        let margin = dimensions.margin;
        let height = dimensions.height;
        let width = dimensions.width;
        let attribute = "total_cases"

        let cloneData = JSON.parse(JSON.stringify(data));

        var latestDate = new Date(date);
        cloneData = cloneData[country].filter(d => {
            let date = new Date(d.date);
            return (date <= latestDate);
        });

        var parseDate = d3.timeParse("%Y-%m-%d");
        cloneData.forEach(function (d) {
            d.date = parseDate(d.date);
        });

        var lineChart = d3.select("#chart")
            .attr("preserveAspectRatio", "xMidYMid meet")
            .attr(
                'viewBox',
                '0 0 ' +
                (width + margin.left + margin.right) +
                ' ' +
                (height + margin.top + margin.bottom)
            )
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Add title
        lineChart.append("text")
            .attr("x", width / 2)
            .attr("y", 0)
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .text(country + "\n " + attribute.replace("_", " "));

        // Add scales
        var xScale = d3.scaleTime()
            .domain(d3.extent(cloneData, function (d) { return d.date; }))
            .range([0, width]);

        var yScale = d3.scaleLinear()
            .domain([0, d3.max(cloneData, function (d) { return +d[attribute]; })])
            .range([height, 0]);

        // Add x-axis
        lineChart.append("g")
            .data(cloneData)
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xScale)
                .tickFormat(d3.timeFormat("%Y-%m-%d"))
            )
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", "rotate(-38)");

        // Add y-axis
        lineChart.append("g")
            .attr("class", "y axis")
            .call(d3.axisLeft(yScale));

        // Draw
        lineChart.append("path")
            .datum(cloneData)
            .attr("fill", "none")
            .attr("stroke", "royalblue")
            .attr("stroke-width", 1.5)
            .attr("d", d3.line()
                .x(function (d) { return xScale(d.date) })
                .y(function (d) { return yScale(+d[attribute]) })
            )
        return;
    }

</script>

</html>